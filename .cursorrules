# CodexFlow.dev â€” Cursor AI Rules
# Version: 2.0 (Decompose Pipeline Edition)
# Date: 27 AralÄ±k 2025

## ğŸ¯ PROJE KÄ°MLÄ°ÄÄ°

Bu proje **CodexFlow.dev** - Cursor AI iÃ§in TL bazlÄ± LLM Gateway platformu.

Temel Ã¶zellikler:
- 4 LiteLLM alias: cf-fast, cf-deep, cf-planner, cf-grace
- Decompose Pipeline: GPT-5 nano planner + Claude executor
- 3 Anthropic org key havuzu
- Grace Lane fallback (kota bitince)
- %30 kar marjÄ± hedefi

---

## ğŸ—ï¸ MÄ°MARÄ° PRENSÄ°PLER

### LiteLLM Alias'larÄ±
```
cf-fast           â†’ Claude Haiku 3.5              â†’ HÄ±zlÄ±, basit iÅŸler
cf-deep           â†’ Claude Sonnet 4               â†’ KarmaÅŸÄ±k logic
cf-planner        â†’ GPT-4o-mini                   â†’ Plan/chunk JSON (ucuz)
cf-grace          â†’ Llama 3.1 405B (OpenRouter)   â†’ Kota bitince (ÃœCRETSÄ°Z!)
cf-grace-fallback â†’ GPT-4o-mini                   â†’ Llama fail olursa
```

### Grace Lane Stratejisi
```
KullanÄ±cÄ± kotasÄ± bitti
    â†“
cf-grace (Llama 405B FREE) dene
    â†“
BaÅŸarÄ±lÄ±? â†’ Return response (maliyet: $0)
    â†“
Fail? â†’ cf-grace-fallback (GPT-4o-mini)
    â†“
Return response (maliyet: $0.15-0.60/1M)
```

### Decompose Pipeline
BÃ¼yÃ¼k request (8K+ token veya 24K+ karakter) geldiÄŸinde:
1. **Planner (cf-planner):** JSON plan Ã¼ret
2. **Chunk A (cf-fast):** Schema + models
3. **Chunk B (cf-deep):** Gateway core
4. **Chunk C (cf-fast):** Jobs + tests

Hard limits:
- Max 1 planner + 3 chunk = 4 call
- Chunk baÅŸÄ±na max 5 dosya
- Total timeout: 8 dakika

### Kota Sistemi
```
Monthly (fast/deep) â†’ Redis DECRBY atomic
Daily safety caps â†’ GÃ¼nlÃ¼k spike Ã¶nleme
Grace (daily only) â†’ Kota bitince fallback
Planner â†’ Sistem overhead, kullanÄ±cÄ± kotasÄ±ndan dÃ¼ÅŸmez
```

---

## ğŸ“ DOSYA YAPISI

```
app/
â”œâ”€â”€ Http/Controllers/
â”‚   â”œâ”€â”€ Api/V1/           # Gateway, Project, ApiKey, Usage
â”‚   â”œâ”€â”€ Auth/             # Login, Logout
â”‚   â”œâ”€â”€ Dashboard/        # Customer UI
â”‚   â””â”€â”€ Admin/            # Admin UI
â”œâ”€â”€ Services/
â”‚   â”œâ”€â”€ Llm/              # Gateway, Decompose, LiteLLM client
â”‚   â”œâ”€â”€ Quota/            # Quota check, decrement, sync
â”‚   â”œâ”€â”€ ApiKey/           # Key generation, validation
â”‚   â””â”€â”€ Usage/            # Aggregation, reporting
â”œâ”€â”€ Middleware/           # Auth, RateLimit, Quota, RequestId
â”œâ”€â”€ Jobs/                 # Aggregate, Prune, Sync
â”œâ”€â”€ Exceptions/Llm/       # Custom exceptions
â””â”€â”€ Models/               # Eloquent models

config/
â”œâ”€â”€ litellm.php           # LiteLLM connection + aliases
â””â”€â”€ codexflow.php         # Plans, quotas, decompose settings

infra/
â”œâ”€â”€ litellm/proxy_config.yaml
â””â”€â”€ easypanel/README.md
```

---

## âœ… KOD YAZIM KURALLARI

### Genel
- PSR-12 standardÄ±
- TÃ¼rkÃ§e yorum YAZMA, Ä°ngilizce kullan
- Single Responsibility prensibi
- DRY (Don't Repeat Yourself)

### Laravel Ã–zel
- Form validasyonu: FormRequest sÄ±nÄ±flarÄ±
- API response: Resources kullan
- Ä°ÅŸ mantÄ±ÄŸÄ±: Service katmanÄ±nda
- Try/catch: Sadece Controller ve Job'larda

### Database
- Migration: `down()` methodu zorunlu
- Index: Foreign key + sÄ±k sorgulanan alanlar
- Enum: MySQL enum kullan
- Timestamp: Laravel conventions

### GÃ¼venlik
- API key: Bcrypt hash + prefix lookup
- SQL: Query Builder veya Eloquent (raw SQL yok)
- CSRF: API routes hariÃ§ aktif
- Rate limit: Redis-based

---

## ğŸ”§ DECOMPOSE KURALLARI

### Trigger KoÅŸullarÄ±
```php
// Otomatik trigger
$shouldDecompose = 
    $request->header('x-decompose') === '1' ||
    $estimatedTokens >= 8000 ||
    strlen(json_encode($messages)) >= 24000;
```

### Planner JSON Schema
```json
{
  "summary": ["line1", "line2"],
  "chunks": [
    {
      "id": "A",
      "title": "...",
      "goal": "...",
      "files": ["path1", "path2"],
      "tier": "fast|deep",
      "max_output_tokens": 700
    }
  ],
  "execution_order": "parallel|sequential"
}
```

### Chunk Execution
- Sadece gerekli dosya parÃ§alarÄ±nÄ± context'e ekle
- max_output_tokens zorunlu
- diff-only output
- Fail eden chunk tekrar, tamamÄ± deÄŸil

---

## ğŸ“Š QUOTA MUHASEBESÄ°

### Redis Keys
```
quota:monthly:{userId}:{YYYY-MM}:fast_in
quota:monthly:{userId}:{YYYY-MM}:fast_out
quota:monthly:{userId}:{YYYY-MM}:deep_in
quota:monthly:{userId}:{YYYY-MM}:deep_out
quota:daily:{userId}:{YYYY-MM-DD}:fast
quota:daily:{userId}:{YYYY-MM-DD}:deep
quota:daily:{userId}:{YYYY-MM-DD}:grace
```

### Atomic Decrement Flow
```php
// Pre-authorize
$estimated = $this->estimateTokens($messages);
$remaining = Redis::decrby($key, $estimated);
if ($remaining < 0) {
    Redis::incrby($key, $estimated); // Rollback
    throw new QuotaExceededException();
}

// Post-adjust (after LLM response)
$actual = $response->usage->total_tokens;
$delta = $actual - $estimated;
Redis::decrby($key, $delta);
```

### Fallback Zinciri
```
deep exhausted â†’ try fast
fast exhausted â†’ try grace (daily)
grace exhausted â†’ 429 + Retry-After
```

---

## ğŸš« YAPILMAMASI GEREKENLER

1. **Vendor SDK kullanma** - TÃ¼m LLM Ã§aÄŸrÄ±larÄ± LiteLLM Ã¼zerinden
2. **Full file rewrite** - Sadece diff/patch
3. **Hardcoded secrets** - Her ÅŸey ENV'de
4. **Direct DB query for quota** - Redis kullan
5. **Tek shot bÃ¼yÃ¼k request** - Decompose et
6. **Planner'a prose yazdÄ±rma** - Sadece JSON
7. **Chunk'ta tÃ¼m repo context** - Sadece gerekli dosyalar

---

## ğŸ“ COMMIT MESAJ FORMATI

```
feat: Add decompose pipeline for large requests
fix: Quota race condition with Redis DECRBY
refactor: Extract TierSelector from GatewayService
test: Add concurrent quota tests
docs: Update API documentation
chore: Update dependencies
```

---

## ğŸ§ª TEST KURALLARI

### Feature Tests
- Mock LiteLLM responses
- Test decompose trigger
- Test quota exhaustion fallback
- Test concurrent requests

### Unit Tests
- Her service iÃ§in ayrÄ± test
- Edge case'ler dahil
- Pure function test (no DB)

---

## ğŸ¨ UI KURALLARI

### Stack
- Blade + Tailwind CSS
- Alpine.js (interactivity)
- Chart.js (graphs)

### TasarÄ±m
- Modern, minimalist
- TÃ¼rkÃ§e arayÃ¼z
- Mobile responsive
- Dark mode desteÄŸi (opsiyonel)

---

## ğŸ“‹ PART SIRASI

```
PART 0 â†’ LiteLLM proxy_config.yaml (4 alias)
PART 1 â†’ Migrations + Models + Config
PART 2 â†’ Auth + API Keys + Middleware
PART 3 â†’ Gateway Core + Decompose Pipeline
PART 4 â†’ Usage + Jobs + Scheduler
PART 5 â†’ Dashboards (Landing + Customer + Admin)
PART 6 â†’ Tests + Infra + Deployment
```

---

## ğŸ”‘ ENV DEÄÄ°ÅKENLERÄ°

```env
# LiteLLM
LITELLM_BASE_URL=http://localhost:4000
LITELLM_MASTER_KEY=

# Anthropic (3 org)
ANTHROPIC_KEY_ORG_A=
ANTHROPIC_KEY_ORG_B=
ANTHROPIC_KEY_ORG_C=

# OpenAI (planner + grace fallback)
OPENAI_API_KEY_PLANNER=
OPENAI_API_KEY_GRACE=

# OpenRouter (Llama 405B FREE - Grace Lane primary)
OPENROUTER_API_KEY=

# Database
DB_HOST=
DB_DATABASE=codexflow
DB_USERNAME=
DB_PASSWORD=

# Redis
REDIS_HOST=
REDIS_PASSWORD=
```

---

## ğŸ’¡ HIZLI REFERANS

### Tier Limitleri
| Tier | Max Input | Max Output | Timeout | Model |
|------|-----------|------------|---------|-------|
| fast | 8000 | 900 | 60s | Claude Haiku |
| deep | 16000 | 1400 | 120s | Claude Sonnet |
| planner | 12000 | 500 | 30s | GPT-4o-mini |
| grace | 8000 | 800 | 90s | Llama 405B (FREE) |
| grace-fallback | 8000 | 800 | 60s | GPT-4o-mini |

### Maliyet (USD per 1M token)
| Tier | Input | Output | Not |
|------|-------|--------|-----|
| fast | $0.80 | $4.00 | Claude Haiku |
| deep | $3.00 | $15.00 | Claude Sonnet |
| planner | $0.15 | $0.60 | GPT-4o-mini |
| grace | **$0** | **$0** | Llama 405B FREE! |
| grace-fallback | $0.15 | $0.60 | GPT-4o-mini |

### Trial Plan (24 Saat Ãœcretsiz)
| Tier | Input | Output | Requests |
|------|-------|--------|----------|
| fast | 200K | 40K | 100 |
| deep | 50K | 10K | 20 |
| grace | **SINIRSIZ** | **SINIRSIZ** | **SINIRSIZ** |

> Trial'da kota biterse Llama 405B FREE ile sÄ±nÄ±rsÄ±z devam!

### Pro Plan KotalarÄ±
| Tier | Input | Output | Requests |
|------|-------|--------|----------|
| fast | 6M | 1.2M | 1500 |
| deep | 400K | 80K | 150 |
| grace | - | - | 50/gÃ¼n |

---

## ğŸ TRIAL SÄ°STEMÄ°

### Ã–zellikler
- **24 saat** Ã¼cretsiz (FOMO yaratÄ±r!)
- Kredi kartÄ± gerektirmez
- Email doÄŸrulamasÄ± zorunlu
- Kota biterse **Llama 405B FREE** ile sÄ±nÄ±rsÄ±z devam

### Anti-Abuse
- Email domain baÅŸÄ±na max 3 trial
- IP baÅŸÄ±na max 2 trial
- Temp mail servisleri engelli

### DÃ¶nÃ¼ÅŸÃ¼m
- Saat 12, 20, 23: HatÄ±rlatma emaili
- 24 saat iÃ§inde upgrade'de %10 indirim
- Aciliyet = yÃ¼ksek conversion rate

---

*CodexFlow.dev Cursor Rules v2.0*

